version: '3.8'

services:
  # ----------------------------------------
  # 1. Servicio de la Aplicación Java (Spring Boot)
  # ----------------------------------------
  spring-app:
    # CLAVE: Usa el nombre de tu repositorio en Docker Hub.
    image: jsalomia/purchase-order-service:1.1.0
    container_name: alomia_app
    ports:
      - "8001:8001"
    environment:
      DB_USER: AppRoot
      DB_PWS: abcd
    # CLAVE: Espera a que la base de datos esté 'healthy' (lista para conexiones).
    depends_on:
      db-mysql:
        condition: service_healthy

  # ----------------------------------------
  # 2. Servicio de la Base de Datos MySQL
  # ----------------------------------------
  db-mysql:
    container_name: sisdb2025_container
    hostname: mysql-sisdb2025
    image: mysql:8.0
    ports:
      - "3307:3306"
    environment:
      MYSQL_DATABASE: sisdb2025
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_USER: AppRoot
      MYSQL_PASSWORD: abcd
    volumes:
      - dbdata:/var/lib/mysql

    # CLAVE: Define el chequeo de salud para que Spring Boot sepa cuándo conectarse.
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p$$MYSQL_ROOT_PASSWORD"]
      interval: 10s # Chequea cada 10 segundos
      timeout: 5s   # Espera 5 segundos por respuesta
      retries: 10   # Reintenta 10 veces antes de fallar
      start_period: 30s # Da 30s iniciales para que MySQL se configure

# ----------------------------------------
# 3. Volúmenes (Persistencia de Datos)
# ----------------------------------------
volumes:
  dbdata:

networks:             # <-- Definimos la red
  app_net:
    driver: bridge
